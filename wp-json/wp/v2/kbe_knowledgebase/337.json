{"id":337,"date":"2017-10-03T13:33:59","date_gmt":"2017-10-03T13:33:59","guid":{"rendered":"https:\/\/nomad.menu\/?post_type=kbe_knowledgebase&#038;p=337"},"modified":"2018-06-19T13:17:23","modified_gmt":"2018-06-19T18:17:23","slug":"troubleshooting-nomad","status":"publish","type":"kbe_knowledgebase","link":"https:\/\/nomad.menu\/help\/troubleshooting-nomad\/","title":{"rendered":"Troubleshooting NoMAD"},"content":{"rendered":"<p>While we make every attempt to ensure a trouble-free experience with NoMAD, there are times when your environment isn&#8217;t what NoMAD is expecting, or when NoMAD has a bug.<\/p>\n<p>Here are a few tips and tricks to get things back on the straight and narrow when you do encounter these scenarios.<\/p>\n<h2><strong>Verbose Logging<\/strong><\/h2>\n<p>The first step in any troubleshooting process is to run NoMAD from the command line and put it into verbose mode. It&#8217;s perfectly acceptable to do this while other copies of NoMAD are running; you&#8217;ll just have multiple icons in the menu bar.<\/p>\n<p>To launch NoMAD in verbose, open up a Terminal window and put the full path to the NoMAD binary, not just the application bundle with -v. For example, if NoMAD is installed in the Applications folder you&#8217;d use this in Terminal:<\/p>\n<p><code>\/Applications\/NoMAD.app\/Contents\/MacOS\/NoMAD -v<\/code><\/p>\n<p>This will launch NoMAD and put all logs directly into the terminal window that&#8217;s already open. This makes it very simple to gather the NoMAD logs and see events happen in real time.<\/p>\n<p>Most issues are at least identifiable in the logs. Some things may jump out, as verbose logging should record a lot of events and information as NoMAD works. The other issue that&#8217;s typically encountered is an &#8220;illegal instruction 4&#8221; error. This typically represents a variable in the code that was expected to have a value, but is empty. NoMAD has a number of checks for these, but there&#8217;s always the chance that either we&#8217;ve left something out, or you have a setting that we&#8217;ve never seen missing a value before.<\/p>\n<h2><strong>Additional CLI Options<\/strong><\/h2>\n<p>There are some other flags you can use when launching from the CLI as well:<\/p>\n<ul>\n<li>&#8220;-prefs&#8221; &#8211; On version 1.1.4 and newer, this will print out all preferences as NoMAD sees them, including whether or not they are being forced via a configuration profile.<\/li>\n<li>&#8220;-rawLDAP&#8221; &#8211; This will list all LDAP queries and responses as NoMAD works. You&#8217;ll get to see the actual ldapsearch syntax being used and the full LDIF response from the LDAP server.<\/li>\n<li>&#8220;-shares&#8221; &#8211; This will list all file shares as seen by NoMAD and give you more verbose output specific to the file shares menu.<\/li>\n<\/ul>\n<p>All of these options can be used together or individually when launching NoMAD from the CLI.<\/p>\n<h2><strong>Configurations<\/strong><\/h2>\n<p>The vast majority of issues we see with organizations using NoMAD are due to configuration issues. Most of these configuration issues are in turn caused by creating malformed configuration profiles, scripting defaults instead of using a configuration profile, or managing preference keys that aren&#8217;t meant to be managed.<\/p>\n<p>The simplest way to test for this is to pull the configuration and see if the problem persists. If the problem is with the configuration itself, the next easiest step is to attempt to validate the XML, if you&#8217;re using a configuration profile.<\/p>\n<p>A good general rule of thumb when dealing with configurations is to manage only as much as you absolutely need to. As an example, you generally shouldn&#8217;t have any settings in NoMAD that are set to a blank value.<\/p>\n<h2><strong>Network and AD<\/strong><\/h2>\n<p>The next most common problem is with either the network or the AD configuration that&#8217;s in use. By now, NoMAD is rather resilient to any network outages and other issues. More common are more &#8220;exotic&#8221; AD configurations. While we&#8217;ve seen a lot of these and have work arounds for most, there are always new ones.<\/p>\n<hr \/>\n<h1><strong>More Troubleshooting Tips<\/strong><\/h1>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">So, you&#8217;ve kinda-sorta got it working, but it&#8217;s not doing what you want&#8230; or it&#8217;s just flat out failing. Here&#8217;s how to replicate what&#8217;s going on manually to find out where things have gone awry.<\/p>\n<h2 dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><strong style=\"font-size: 20px; line-height: 1.6em;\">1. SRV Records<\/strong><\/h2>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">The first thing NoMAD does is attempt to look up your AD Domain Controllers via a DNS lookup for any LDAP SRV records. For the following examples, we&#8217;ll be using &#8220;company.com&#8221; as your AD domain and &#8220;server.company.com&#8221; as your AD Domain Controller. If you&#8217;re playing along at home, swap your real information in for these examples:<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><code>dig +short -t SRV _ldap._tcp.company.com<\/code><\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">This will query DNS for any LDAP SRV records. If you don&#8217;t get any results, this means that you&#8217;re <strong>a)<\/strong> not able to reach your corporate AD domain, at which point it&#8217;s probably a VPN issue or general network issue, or that\u00a0<strong>b)<\/strong> you can&#8217;t get any DNS resolution for your domain. Make sure that you&#8217;re using the expected DNS servers, or that you can actually reach your internal network.<\/p>\n<h2 dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><strong style=\"font-size: 20px; line-height: 1.6em;\">2. Kerberos Login<\/strong><\/h2>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">Once you&#8217;ve gotten some results of the SRV lookup, the next step is to attempt to get a Kerberos ticket with an AD username and password:<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><code>kinit user@COMPANY.COM<\/code><\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">No news is good news here, but you can test to ensure that it worked by using the <code>klist<\/code> command, which should show that you have a Kerberos TGT for your domain.<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">If this doesn&#8217;t work, it&#8217;s most likely that you are once again unable to reach any of the AD Domain Controllers.<\/p>\n<h2 dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><strong style=\"font-size: 20px; line-height: 1.6em;\">3. LDAP Queries<\/strong><\/h2>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">If you were able to login via Kerberos, you can try looking up information via LDAP.<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">Use any of the servers that you find via the <code>dig<\/code> command in the first step and attempt to do an LDAP query against it:<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><code>ldapsearch -LLL -Q -H ldap:\/\/server.company.com -s base defaultNamingContext<\/code><\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">This should return a chunk of text with a defaultNamingContext attribute in it. This lets you know that you can in fact use that username and password to lookup information via LDAP.<\/p>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">If this doesn&#8217;t work, you&#8217;re probably either not on the internal network, or you may have some funky access rights in AD that will cause further issues.<\/p>\n<h2 dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\"><strong style=\"font-size: 20px; line-height: 1.6em;\">4. Windows CA Troubleshooting<\/strong><\/h2>\n<p dir=\"auto\" style=\"font-size: 16px; line-height: 1.75em;\">Listed below are few top tips for working with Windows Certificate Authorities (CA). Much like the rest of NoMAD there isn&#8217;t any real magic to this as well. NoMAD will leverage your AD credentials to request a certificate from the CA&#8217;s web portal. In order to regress any issues you can manually attempt this process by just using Safari.<\/p>\n<ul>\n<li class=\"code highlight js-syntax-highlight plaintext white\"><code>Use NoMAD to ensure you are logged in with your AD user and that you have a valid Kerberos TGT<br \/>\n<\/code><\/li>\n<li class=\"code highlight js-syntax-highlight plaintext white\"><code>Use Safari, as it's Kerberos-aware by default, to connect to the CA web portal. This typically be in the style of ```https:\/\/x509.domain.com\/certsrv```<br \/>\n<\/code><\/li>\n<li class=\"code highlight js-syntax-highlight plaintext white\"><code>You should be automatically logged in. If you are presented with a security dialog about trusting the CA's SSL cert, this may be where things are going wrong. Import that CA's root cert into your local keychain and trust it. NoMAD won't connect if the web server is untrusted. If you're not automatically logged in, the web portal is most likely not set to use \"Windows Authentication\" which is just a checkbox in the Microsoft IIS settings. Without this set, the web portal will be asking for a password and not a Kerberos ticket.<br \/>\n<\/code><\/li>\n<li class=\"code highlight js-syntax-highlight plaintext white\"><code>If all of that works, you should be able to request a certificate through the web portal. Note that some earlier versions, i.e. pre-Windows 2008, of the portal leveraged ActiveX in the web page and may not work on a Mac. When you go through this process, you should be able to specify a certificate template to use. You should use that same template name in NoMAD.<\/code><\/li>\n<\/ul>\n<h2><strong>Reporting Issues<\/strong><\/h2>\n<p>If you&#8217;re a support customer, please use the support email and we&#8217;ll get to work on figuring out what&#8217;s going on for you. In addition, or if you don&#8217;t have a support contract, you can file an issue on the <a href=\"https:\/\/gitlab.com\/Mactroll\/NoMAD\">NoMAD GitLab<\/a> page or hop into the #nomad Slack channel at<a href=\"http:\/\/macadmins.slack.com\"> macadmins.slack.com<\/a>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>While we make every attempt to ensure a trouble-free experience with NoMAD, there are times when your environment isn&#8217;t what NoMAD is expecting, or when NoMAD has a bug. Here are a few tips and tricks to get things back on the straight and narrow when you do encounter these scenarios. Verbose Logging The first [&hellip;]<\/p>\n","protected":false},"author":3,"featured_media":0,"comment_status":"closed","ping_status":"closed","template":"","kbe_taxonomy":[21],"kbe_tags":[],"_links":{"self":[{"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/kbe_knowledgebase\/337"}],"collection":[{"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/kbe_knowledgebase"}],"about":[{"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/types\/kbe_knowledgebase"}],"author":[{"embeddable":true,"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/users\/3"}],"replies":[{"embeddable":true,"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/comments?post=337"}],"version-history":[{"count":0,"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/kbe_knowledgebase\/337\/revisions"}],"wp:attachment":[{"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/media?parent=337"}],"wp:term":[{"taxonomy":"kbe_taxonomy","embeddable":true,"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/kbe_taxonomy?post=337"},{"taxonomy":"kbe_tags","embeddable":true,"href":"https:\/\/nomad.menu\/wp-json\/wp\/v2\/kbe_tags?post=337"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}